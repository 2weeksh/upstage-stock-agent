class ModeratorAgent:
    def __init__(self, llm):
        self.llm = llm

    """(수급, 재무 건전성, 장기 성장성 등)새로운 관점으로 전환시키세요"""
    # reports(기초 리포트) 외에 debate_history(진행된 토론 내용)를 추가로 받음
    def facilitate(self, company_name, reports):
        prompt = f"""
        당신은 주식 전문 토론회의 사회자입니다. {company_name}에 대한 토론이 진행 중입니다.
        
        [전체 토론 맥락]
        {reports}
        
        [지시사항]
        1. 위 맥락을 읽고, **이미 충분히 논의된 내용은 요약에서 제외**하세요.
        2. 아직 해결되지 않은 의문이나, 방금 전 발언자가 한 말 중 '논리적 허점'이 있는 부분을 찾으세요.
        3. **동일한 질문을 반복하지 마세요.** 토론을 새로운 관점으로 전환시키세요.
        4. 다음 발언자는 직전 발언자와 다른 전문가를 우선적으로 지목하세요.
            
        [출력 형식 가이드]
        반드시 아래 형식을 유지하세요 (이모지 포함):
        ---
        > 📢 **사회자(Moderator) 중재**
        > 
        > * **⚖️ 핵심 충돌 지점:** (현재 논쟁의 중심이 되는 키워드 요약)
        > * **🔍 논리적 허점 포착:** (에이전트의 주장 중 재검증이 필요한 부분)
        > * **🎤 반박/보완 요청:** (지목된 전문가에게 던지는 구체적인 질문)
        ---
        **[NEXT]: Chart** 또는 **[NEXT]: News** 또는 **[NEXT]: Finance** (하나만 선택)
        """
        return self.llm.invoke(prompt).content


    def summarize(self, company_name, full_history):
        """2단계: 모든 토론 과정을 지켜보고 최종 결론을 내림"""
        prompt = f"""
        당신은 최종 의사결정권자이자 수석 퀀트 분석가입니다. 
        아래의 토론 기록을 바탕으로 {company_name}에 대한 최종 투자 등급을 '정량적 스코어'로 산출하세요.

        [전체 토론 기록]
        {full_history}

        ---
        [채점 가이드라인 (Total: 10점)]
        1. 기술적 분석 (3점): 차트 추세, 거래량, 주요 지표(RSI, MACD 등)
        2. 기본적 분석 (3점): 실적, 저평가 여부(PER/PBR), 재무 건전성
        3. 시장 심리 및 뉴스 (4점): 토론에서 언급된 최신 호재/악재, 수급 상황

        [최종 등급 기준표]
        - 8.0 ~ 10.0: [강력 매수] - 압도적 호재와 상승 모멘텀
        - 6.0 ~ 7.9: [매수] - 전반적 우상향 기대 및 긍정적 지표
        - 4.0 ~ 5.9: [중립] - 방향성 불분명, 관망 필요
        - 2.0 ~ 3.9: [매도] - 하방 압력 존재 및 리스크 관리 필요
        - 0.0 ~ 1.9: [강력 매도] - 심각한 악재 또는 하락 추세 뚜렷
        ---

        반드시 아래 형식을 엄격히 지켜서 출력하세요:

        반드시 아래의 '마크다운 형식'을 엄격히 지켜서 출력하세요:

        # 🏆 {company_name} 최종 투자 전략 보고서
        > **종합 투자 스코어: [점수] / 10.0**

        ---
        ### 📊 부문별 분석 결과
        | 분석 항목 | 배점 | 스코어 | 핵심 요약 |
        | :--- | :---: | :---: | :--- |
        | **기술적 분석** | 3.0 | **n/3** | 차트 및 지표 요약 |
        | **기본적 분석** | 3.0 | **n/3** | 재무 및 밸류에이션 요약 |
        | **시장 심리** | 4.0 | **n/4** | 뉴스 및 수급 상황 요약 |

        ### 💡 핵심 결정 이유
        1. **[근거 제목 1]**: (토론에서 도출된 가장 중요한 결론)
        2. **[근거 제목 2]**: (데이터와 수치에 기반한 판단 근거)
        3. **[근거 제목 3]**: (리스크 요인 또는 기회 요인 정리)

        ### 📉 최종 실행 지침 (Action Plan)
        * **📍 진입 타점:** [추천 매수 가격대 또는 특정 돌파 조건]
        * **⚠️ 리스크 관리:** [손절 라인 및 주의해야 할 변수]
        * **🎯 목표 수익:** [단기/중기 목표가]
        """
    
        return self.llm.invoke(prompt).content


        
